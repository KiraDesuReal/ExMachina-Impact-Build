<?xml version="1.0" encoding="windows-1251" standalone="yes" ?>
<triggers>

	<trigger Name="GlobalVar" active="1">
		<event timeout="0" eventid="GE_TIME_PERIOD" />
		<script>
			CreateNewDummyObject("post_challenge", "post", -1, -1, CVector(739.525, 254.800, 983.778), Quaternion(0, 0, 0, 1), 0)
			trigger:Deactivate()
		</script>
	</trigger>

<!-- Установка стандартных значений при запуске карты -->
	<trigger Name="StartMap" active="1">
		<event eventid="GE_GAME_START" ObjName="Player1" />
		<script>
			SetVar("SoundCreateKey",0)
			SetVar("RotateKey",0)
			SetVar("Score",0)

			TActivate("Tutorial")
			TActivate("CreateKey_EntresLoc")

			SetCameraBehindPlayerVehicle()
		</script>
	</trigger>

	<trigger Name="Tutorial" active="0">
		<event 	timeout="1" eventid="GE_TIME_PERIOD" />
		<script>
			SpawnMessageBox("3")
			trigger:Deactivate()
		</script>
	</trigger>

	<trigger Name="Ambient" active="1">
		<event 	timeout="0.5" eventid="GE_TIME_PERIOD" />
		<script>
			CreateNewSgNodeObject("ET_S_DUNGEON_AMBIENT_1", "ambient", -1, -1, CVector(745.285, 665.711, 1002.945), Quaternion(0, 0, 0, 1), 0)
			trigger:Deactivate()
		</script>
	</trigger>

<!-- Выход с карты -->
	<trigger Name="ExitFromMap_loc" active="1">
		<event eventid="GE_OBJECT_ENTERS_LOCATION" ObjName="Exit1_loc" />
		<event eventid="GE_OBJECT_ENTERS_LOCATION" ObjName="Exit2_loc" />
		<script>
			local b = SpawnMessageBox("2")
			if b == 1 then
				local vehPlayer = GetPlayerVehicle()
				if vehPlayer then
					vehPlayer:SetCustomControlEnabled( true )
					vehPlayer:SetCustomLinearVelocity( 0 )
					vehPlayer:SetThrottle( 0 )
					vehPlayer:SetCustomControlEnabled( false )
				end
			end
		</script>
	</trigger>

<!-- Создание ворот -->
	<trigger Name="CreateGate" active="0">
		<event 	timeout="0.01" eventid="GE_TIME_PERIOD" />
		<script>
			CreateNewDummyObject("quay_round_line", "quay1", -1, -1, CVector(621.864, 254.545, 984.225), Quaternion(0.0000, -0.7071, 0.0000, 0.7071), 0)
			CreateNewSgNodeObject("agro_gate", "gate1Sg", -1, -1, CVector(628.390, 254.545, 982.722), Quaternion(0.0000, -0.7071, 0.0000, 0.7071), 2.2)

			CreateNewDummyObject("quay_round_line", "quay2", -1, -1, CVector(855.358, 254.545, 981.329), Quaternion(0.0000, 0.7071, 0.0000, 0.7071), 0)
			CreateNewSgNodeObject("agro_gate", "gate2Sg", -1, -1, CVector(848.853, 254.545, 982.735), Quaternion(0.0000, 0.7071, 0.0000, 0.7071), 2.2)

			CreateEffectInsertedInRemove("ET_PS_EXPLOSION_GATE_DUNGEON", CVector(621.864, 254.545, 984.225), Quaternion(0, 0, 0, 1), true)
			CreateEffectInsertedInRemove("ET_PS_EXPLOSION_GATE_DUNGEON", CVector(855.358, 254.545, 981.329), Quaternion(0, 0, 0, 1), true)
			trigger:Deactivate()
		</script>
	</trigger>

	<trigger Name="RemoveGate" active="0">
		<event 	timeout="0.01" eventid="GE_TIME_PERIOD" />
		<script>
			for i=1,2 do
				local gate = GetEntityByName("gate"..i.."Sg")
				if gate then gate:Remove() end
			end

			for i=1,2 do
				local quay = GetEntityByName("quay"..i)
				if quay then quay:Remove() end
			end
			trigger:Deactivate()
		</script>
	</trigger>

<!-- Создание 'ключа' для начала испытания -->
	<trigger Name="CreateKey_EntresLoc" active="0">
		<event eventid="GE_OBJECT_ENTERS_LOCATION" ObjName="CreateKey_loc" />
		<script>
			SetVar("SoundCreateKey",1)
			TActivate("CreateKey")
			trigger:Deactivate()
		</script>
	</trigger>

	<trigger Name="CreateKey" active="0">
		<event 	timeout="0.01" eventid="GE_TIME_PERIOD" />
		<script>
	
			CreateNewDummyObject("post_challenge_sword", "sword", -1, -1, CVector(739.525, 254, 983.778), Quaternion(0.0000, 0.7071, 0.0000, 0.7071), 0)
			CreateNewSgNodeObject("ET_PS_LENS_D1", "frame_red", -1, -1, CVector(739.525, 257.100, 983.778), Quaternion(0.0000, 0.7071, 0.0000, 0.7071), 1)
			CreateEffectInsertedInRemove("ET_PS_DRONE_EX_D", CVector(739.525, 265, 983.778), Quaternion(0, 0, 0, 1), true)

			CreateNewSgNodeObject("ET_S_DUNGEON_AMBIENT_KEY", "SdKey", -1, -1, CVector(739.957, 254, 984.051), Quaternion(0, 0, 0, 1), 0)
			if GetVar("SoundCreateKey").AsInt==1 then
				CreateEffectInsertedInRemove("ET_S_DUNGEON_CREATE_KEY", CVector(739.525, 275, 983.778), Quaternion(0, 0, 0, 1), true)
				SetVar("SoundCreateKey",0)
			end

			TActivate("RotateKey")
			TActivate("Start_YesOrNot")

			trigger:Deactivate()
		</script>
	</trigger>

	<trigger Name="RotateKey"	active="0">
		<event	timeout="0.01"		eventid="GE_TIME_PERIOD" />
		<script>

			local k = getObj("sword")
			local zq = 	Quaternion(0, 0, 0, 1)
			if GetVar("RotateKey").AsInt==0 then
				zq:RotY(RAD(0.2))
			else 
				zq:RotY(RAD(1.2))
			end
			if k then
			    local rot = k:GetRotation()
            	k:SetRotation(zq*rot)
			end
			
		</script>
	</trigger>

	<trigger Name="RemoveKey" active="0">
		<event 	timeout="0.01" eventid="GE_TIME_PERIOD" />
		<script>
			
			local k = GetEntityByName("sword")
			if k then k:Remove() end

			local kf = GetEntityByName("frame_red")
			if kf then kf:Remove() end

			local sd = GetEntityByName("SdKey")
			if sd then sd:Remove() end
			
			CreateEffectInsertedInRemove("ET_PS_DRONE_EX_D", CVector(739.525, 265, 983.778), Quaternion(0, 0, 0, 1), true)

			TDeactivate("RotateKey")

			trigger:Deactivate()
		</script>
	</trigger>

<!-- Активация\Деактивация 'ключа' -->
	<trigger Name="ActivateKey" active="0">
		<event 	timeout="0.01" eventid="GE_TIME_PERIOD" />
		<script>

			SetVar("RotateKey",1)
			
			local kf = GetEntityByName("frame_red")
			if kf then kf:Remove() end

			local p = GetEntityByName("post")
			if p then p:SetSkin(1) end

			local sw = GetEntityByName("sword")
			if sw then sw:SetSkin(1) end

			local sd = GetEntityByName("SdKey")
			if sd then sd:Remove() end

			CreateNewSgNodeObject("ET_PS_LENS_D5", "frame_blue", -1, -1, CVector(739.525, 257.100, 983.778), Quaternion(0.0000, 0.7071, 0.0000, 0.7071), 1)
			CreateNewSgNodeObject("ET_S_POST_CHALLENGE_ROTATE", "SdPostRot", -1, -1, CVector(739.957, 254, 984.051), Quaternion(0, 0, 0, 1), 0)

			TActivate("SwordUp")
			trigger:Deactivate()
		</script>
	</trigger>

	<trigger Name="SwordUp" active="0">
		<event 	timeout="0.01"		eventid="GE_TIME_PERIOD" />
		<script>
			local sw = getObj("sword")
			local swCoor = sw:GetPosition()
			swCoor.y = swCoor.y + 0.015
			sw:SetPosition(swCoor)

			TActivate("DeaSword_Y")
		</script>
	</trigger>

	<trigger Name="SwordDown" active="0">
		<event 	timeout="0.01"		eventid="GE_TIME_PERIOD" />
		<script>
			local sw = getObj("sword")
			local swCoor = sw:GetPosition()
			swCoor.y = swCoor.y - 0.015
			sw:SetPosition(swCoor)

			TActivate("DeaSword_Y")
		</script>
	</trigger>

	<trigger Name="DeaSword_Y" active="0">
		<event 	timeout="0.5"		eventid="GE_TIME_PERIOD" />
		<script>
			TDeactivate("SwordUp")
			TDeactivate("SwordDown")
			trigger:Deactivate()
		</script>
	</trigger>

	<trigger Name="DeActivateKey" active="0">
		<event 	timeout="0.01" eventid="GE_TIME_PERIOD" />
		<script>

			SetVar("RotateKey",0)
			
			local kf = GetEntityByName("frame_blue")
			if kf then kf:Remove() end

			local p = GetEntityByName("post")
			if p then p:SetSkin(0) end

			local sw = GetEntityByName("sword")
			if sw then sw:SetSkin(0) end

			local sd = GetEntityByName("SdPostRot")
			if sd then sd:Remove() end

			CreateNewSgNodeObject("ET_PS_LENS_D1", "frame_red", -1, -1, CVector(739.525, 257.100, 983.778), Quaternion(0.0000, 0.7071, 0.0000, 0.7071), 1)
			CreateNewSgNodeObject("ET_S_DUNGEON_AMBIENT_KEY", "SdKey", -1, -1, CVector(739.957, 254, 984.051), Quaternion(0, 0, 0, 1), 0)
			
			TActivate("SwordDown")
			trigger:Deactivate()
		</script>
	</trigger>

<!-- Начало испытания -->
	<trigger Name="Start_YesOrNot" active="0">
		<event eventid="GE_OBJECT_ENTERS_LOCATION" ObjName="Start_loc" />
		<script>
			local b = SpawnMessageBox("1")
			if b == 1 then
				TActivate("CreateGate")
				TActivate("ActivateKey")
				TActivate("StartChallenge")
				trigger:Deactivate()
			end
		</script>
	</trigger>

	<trigger Name="StartChallenge" active="0">
		<event 	timeout="0.01" eventid="GE_TIME_PERIOD" />
		<script>
			AddImportantFadingMsgByStrIdFormatted("fm_start_challenge")

			local randMusic = random(2)
			PlayCustomMusic ("sumeru_battle_"..randMusic)

			local Plf = GetPlayerVehicle()
			local PlfCoor = Plf:GetPosition()
			if Plf then
				CreateEffectInsertedInRemove("ET_S_DUNGEON_START", PlfCoor, Quaternion(0, 0, 0, 1), true)
			end
			
			local randCar = random(3)
			local RandomSmlList = {"Sml101", "Sml201", "Sml301", "Sml401"}
			local RandomSml = getn(RandomSmlList)

			TeamCreate("Enemy1", 1002, CVector(getPos("SpawnEnemy1_loc")), {RandomSmlList[exrandom(RandomSml)], RandomSmlList[exrandom(RandomSml)], RandomSmlList[exrandom(RandomSml)]}, nil, 0)

			for i=0,2 do
				local Enemy = GetEntityByName ("Enemy1_vehicle_"..i)
				local EnCoor = Enemy:GetPosition()
				if Enemy then 
					Enemy:SetRotation(Quaternion(-0.002, -0.723, -0.003, 0.691))
					Enemy:setImmortalMode(1)
					CreateEffectInsertedInRemove("ET_PS_DRONE_EX_D", EnCoor, Quaternion(0, 0, 0, 1), true)
				end
				TActivate("Enemy"..i.."_Dead")
			end

			TActivate("EnemyFaze1_AllDead")

			trigger:Deactivate()
		</script>
	</trigger>

	<trigger Name="Enemy0_Dead" active="0">
		<event eventid="GE_VEHICLE_WITHOUT_HEALTH" ObjName="Enemy1_vehicle_0" />
		<script>

			local EnemyQ1 = GetEntityByName ("Enemy1_vehicle_0")
			local EnCoor1 = EnemyQ1:GetPosition()
			if EnemyQ1 then 
				CreateEffectInsertedInRemove("ET_PS_VEH_EXP2_MED1", EnCoor1, Quaternion(0, 0, 0, 1), true)
				EnemyQ1:Remove()
			end
				
			local sc = 50
			local l = GetVar("Score").AsInt
			l = l + sc

			AddFadingMsgByStrIdFormatted("fm_challenge_score", l)
			SetVar("Score",l)
			trigger:Deactivate()
		</script>
	</trigger>

	<trigger Name="Enemy1_Dead" active="0">
		<event eventid="GE_VEHICLE_WITHOUT_HEALTH" ObjName="Enemy1_vehicle_1" />
		<script>

			local EnemyQ1 = GetEntityByName ("Enemy1_vehicle_1")
			local EnCoor1 = EnemyQ1:GetPosition()
			if EnemyQ1 then 
				CreateEffectInsertedInRemove("ET_PS_VEH_EXP2_MED1", EnCoor1, Quaternion(0, 0, 0, 1), true)
				EnemyQ1:Remove()
			end
				
			local sc = 50
			local l = GetVar("Score").AsInt
			l = l + sc

			AddFadingMsgByStrIdFormatted("fm_challenge_score", l)
			SetVar("Score",l)
			trigger:Deactivate()
		</script>
	</trigger>

	<trigger Name="Enemy2_Dead" active="0">
		<event eventid="GE_VEHICLE_WITHOUT_HEALTH" ObjName="Enemy1_vehicle_2" />
		<script>

			local EnemyQ1 = GetEntityByName ("Enemy1_vehicle_2")
			local EnCoor1 = EnemyQ1:GetPosition()
			if EnemyQ1 then 
				CreateEffectInsertedInRemove("ET_PS_VEH_EXP2_MED1", EnCoor1, Quaternion(0, 0, 0, 1), true)
				EnemyQ1:Remove()
			end
				
			local sc = 50
			local l = GetVar("Score").AsInt
			l = l + sc

			AddFadingMsgByStrIdFormatted("fm_challenge_score", l)
			SetVar("Score",l)
			trigger:Deactivate()
		</script>
	</trigger>

	<trigger Name="EnemyFaze1_AllDead" active="0">
		<event eventid="GE_OBJECT_DIE" ObjName="Enemy1_vehicle_0" />
		<event eventid="GE_OBJECT_DIE" ObjName="Enemy1_vehicle_1" />
		<event eventid="GE_OBJECT_DIE" ObjName="Enemy1_vehicle_2" />
		<script>

			trigger:IncCount()
			local count = trigger:GetCount()
			if 3>count then
			return
			end

			TActivate("ChallengeFaze2")
			trigger:Deactivate()
		</script>
	</trigger>

	<trigger Name="ChallengeFaze2" active="0">
		<event 	timeout="0.01" eventid="GE_TIME_PERIOD" />
		<script>
	
			local RandomLocList = {"SpawnEnemy1_loc", "SpawnEnemy2_loc", "SpawnEnemy3_loc", "SpawnEnemy4_loc"}
			local RandomLoc = random(4)

			local Rotate = ""
			local RandomCarList = ""
			local RandomCar = ""

			if RandomLoc == 1 then
				Rotate = Quaternion(0.007, 0.711, 0.007, -0.703)
			elseif RandomLoc == 2 then
				Rotate = Quaternion(0.000, 1.000, 0.009, 0.011)
			elseif RandomLoc == 3 then
				Rotate = Quaternion(0.009, 0.008, -0.000, -1.000)
			elseif RandomLoc == 4 then
				Rotate = Quaternion(0.007, -0.701, -0.007, -0.713)
			end

			local l = GetVar("Score").AsInt
	
			if (150 >= l) then
				RandomCarList = {"Sml101", "Sml201", "Sml301", "Sml401"}
				RandomCar = getn(RandomCarList)
				println("150 > l")
			elseif (l >= 2000) then
				RandomCarList = {"Mirotvorec01", "Dozer01", "Cruiser01", "Cruiser02", "CoolBelaz_2"}
				RandomCar = getn(RandomCarList)
				println("l > 2000")
			elseif (l >= 1700) then
				RandomCarList = {"Mirotvorec01", "Cruiser01", "Cruiser02", "CoolBelaz_2", "r2m1_Belaz01", "Gladiator02"}
				RandomCar = getn(RandomCarList)
				println("l > 1700")
			elseif (l >= 1500) then
				RandomCarList = {"Belaz01", "CoolBelaz_2", "CoolBelaz", "BelazShot", "r2m1_Belaz01", "Gladiator02", "r2m1_Ural01", "r2m2_Ural01"}
				RandomCar = getn(RandomCarList)
				println("l > 1500")
			elseif (l >= 1200) then
				RandomCarList = {"Ural00", "Ural01", "Ural02", "UralShot", "r2m1_Ural01", "r2m2_Ural01"}
				RandomCar = getn(RandomCarList)
				println("l > 1200")
			elseif (l >= 1000) then
				RandomCarList = {"r1m1_molokovoz02", "r2m1_Molokovoz01", "r2m2_Molokovoz01", "r1m1_molokovoz01", "r1m1_molokovoz03"}
				RandomCar = getn(RandomCarList)
				println("l > 1000")
			elseif (l >= 800) then
				RandomCarList = {"r1m2_bug04", "Bug02", "PublicDemoBug01", "Hunter01", "r2m1_HunterNarcBoss", "r2m2_ShamanHunter01", "Fighter02", "r1m3_Fighter02", "r2m1_FighterGulik", "r2m1_FighterNarcCaravan"}
				RandomCar = getn(RandomCarList)
				println("l > 800")
			elseif (l >= 550) then
				RandomCarList = {"Bug01", "r1m1_bug02", "r1m1_bug03", "r1m2_bug04", "Bug02", "PublicDemoBug01", "r2m1_Hunter01", "r2m2_ShamanHunter02"}
				RandomCar = getn(RandomCarList)
				println("l > 550")
			elseif (l >= 300) then
				RandomCarList = {"Scout02", "Scout03", "r1m1_scout03", "FelixVehicle", "Fighter01", "DemoFighter1", "Fighter03", "r2m2_ShamanHunter02"}
				RandomCar = getn(RandomCarList)
				println("l > 300")
			elseif (l >= 150) then
				RandomCarList = {"Sml101", "Sml201", "Sml301", "Sml401", "Scout01", "Scout02", "Scout03", "r1m1_scout03", "r1m1_scout02", "r2m2_scout01", "FelixVehicle", "Fighter01"}
				RandomCar = getn(RandomCarList)
				println("l > 150")
			end

			local randCar = random(4)
			local Car = ""

			if randCar == 1 then
				Car = {RandomCarList[exrandom(RandomCar)]}
			elseif randCar == 2 then
				Car = {RandomCarList[exrandom(RandomCar)], RandomCarList[exrandom(RandomCar)]}
			elseif randCar == 3 then
				Car = {RandomCarList[exrandom(RandomCar)], RandomCarList[exrandom(RandomCar)], RandomCarList[exrandom(RandomCar)]}
			elseif randCar == 4 then
				Car = {RandomCarList[exrandom(RandomCar)], RandomCarList[exrandom(RandomCar)], RandomCarList[exrandom(RandomCar)], RandomCarList[exrandom(RandomCar)]}
			end

			TeamCreate("Enemy2", 1002, CVector(getPos(RandomLocList[RandomLoc])), Car, nil, 0, Rotate)
			
			local forI = randCar - 1

			for i=0,forI do
				local Enemy = GetEntityByName ("Enemy2_vehicle_"..i)
				local EnCoor = Enemy:GetPosition()
				if Enemy then 
					Enemy:setImmortalMode(1)
					CreateEffectInsertedInRemove("ET_PS_DRONE_EX_D", EnCoor, Quaternion(0, 0, 0, 1), true)
				end
				TActivate("Enemy"..i.."_DeadFaze2")
			end

			TActivate("EnemyFaze2_AllDead")

			trigger:Deactivate()
		</script>
	</trigger>

	<trigger Name="Enemy0_DeadFaze2" active="0">
		<event eventid="GE_VEHICLE_WITHOUT_HEALTH" ObjName="Enemy2_vehicle_0" />
		<script>

			local EnemyQ1 = GetEntityByName ("Enemy2_vehicle_0")
			local EnCoor1 = EnemyQ1:GetPosition()
			if EnemyQ1 then 
				CreateEffectInsertedInRemove("ET_PS_VEH_EXP2_MED1", EnCoor1, Quaternion(0, 0, 0, 1), true)
				EnemyQ1:Remove()
			end
				
			local sc = 50
			local l = GetVar("Score").AsInt
			l = l + sc

			AddFadingMsgByStrIdFormatted("fm_challenge_score", l)
			SetVar("Score",l)
			trigger:Deactivate()
		</script>
	</trigger>

	<trigger Name="Enemy1_DeadFaze2" active="0">
		<event eventid="GE_VEHICLE_WITHOUT_HEALTH" ObjName="Enemy2_vehicle_1" />
		<script>

			local EnemyQ1 = GetEntityByName ("Enemy2_vehicle_1")
			local EnCoor1 = EnemyQ1:GetPosition()
			if EnemyQ1 then 
				CreateEffectInsertedInRemove("ET_PS_VEH_EXP2_MED1", EnCoor1, Quaternion(0, 0, 0, 1), true)
				EnemyQ1:Remove()
			end
				
			local sc = 50
			local l = GetVar("Score").AsInt
			l = l + sc

			AddFadingMsgByStrIdFormatted("fm_challenge_score", l)
			SetVar("Score",l)
			trigger:Deactivate()
		</script>
	</trigger>

	<trigger Name="Enemy2_DeadFaze2" active="0">
		<event eventid="GE_VEHICLE_WITHOUT_HEALTH" ObjName="Enemy2_vehicle_2" />
		<script>

			local EnemyQ1 = GetEntityByName ("Enemy2_vehicle_2")
			local EnCoor1 = EnemyQ1:GetPosition()
			if EnemyQ1 then 
				CreateEffectInsertedInRemove("ET_PS_VEH_EXP2_MED1", EnCoor1, Quaternion(0, 0, 0, 1), true)
				EnemyQ1:Remove()
			end
				
			local sc = 50
			local l = GetVar("Score").AsInt
			l = l + sc

			AddFadingMsgByStrIdFormatted("fm_challenge_score", l)
			SetVar("Score",l)
			trigger:Deactivate()
		</script>
	</trigger>

	<trigger Name="Enemy3_DeadFaze2" active="0">
		<event eventid="GE_VEHICLE_WITHOUT_HEALTH" ObjName="Enemy2_vehicle_3" />
		<script>

			local EnemyQ1 = GetEntityByName ("Enemy2_vehicle_3")
			local EnCoor1 = EnemyQ1:GetPosition()
			if EnemyQ1 then 
				CreateEffectInsertedInRemove("ET_PS_VEH_EXP2_MED1", EnCoor1, Quaternion(0, 0, 0, 1), true)
				EnemyQ1:Remove()
			end
				
			local sc = 50
			local l = GetVar("Score").AsInt
			l = l + sc

			AddFadingMsgByStrIdFormatted("fm_challenge_score", l)
			SetVar("Score",l)
			trigger:Deactivate()
		</script>
	</trigger>

	<trigger Name="EnemyFaze2_AllDead" active="0">
		<event 	timeout="3" eventid="GE_TIME_PERIOD" />
		<script>

			if getObj("Enemy0_DeadFaze2"):IsActivated()==0 and getObj("Enemy1_DeadFaze2"):IsActivated()==0 and getObj("Enemy2_DeadFaze2"):IsActivated()==0 and getObj("Enemy3_DeadFaze2"):IsActivated()==0 then
				trigger:Deactivate()
				TActivate("ChallengeFaze2")
			end
		
		</script>
	</trigger>

</triggers>